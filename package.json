{
  "name": "protovm-profiles",





































































































































































































































































































































































































































































































































































































































































- [ ] Revenue sharing on announcements- [ ] NFT collection-gated messaging- [ ] Integration with more protocols (Nostr, etc.)- [ ] Message editing/deletion- [ ] Typing indicators- [ ] Message search/filtering- [ ] File/image message support- [ ] Group messaging (multi-person conversations)## Future Enhancements6. **Validate encryption type** on message send5. **Set expiration on announcements** to keep UI clean4. **Batch broadcast to badges** instead of individual messages3. **Use XMTP for sensitive** communications2. **Handle blocking gracefully** in UI1. **Always check permissions** before allowing messaging## Best Practices- Permissions are enforced at the database level- Blocked users cannot message- Users can only send messages in their conversations- Users can only see their own conversationsAll messaging tables have RLS policies:## Row-Level Security (RLS)```});  }    relatedBadgeId: "uuid"    customField: "value",  metadata: {await sendMessage(toAddress, "Hello!", "xmtp", {```typescriptAttach custom data to messages:### Message Metadata```}  encryption_type: "xmtp"  on_chain_tx_hash: "0x...", // Optional blockchain verification  content: "Important message",  sender_address: "0x...",  conversation_id: "uuid",{```typescriptMessages can include on-chain transaction hashes:### On-Chain Message Verification```});  },    customRule: 'must_be_active_for_30_days',  metadata: {  permissionType: 'custom',  requiresVerification: true,  minFollowerCount: 50,  badgeId: 'badge-uuid',await setMessagePermissions(conversationId, {// Require: Badge + Verification + Min followers```typescriptCreate complex gating rules:### Custom Permission Logic## Advanced Features```}  }, [userAddress]);    initializePushProtocol(walletClient);    initializeXMTP(walletClient);    // Initialize messaging services  useEffect(() => {  const { initializePushProtocol } = usePushProtocol(userAddress);  const { initializeXMTP } = useXMTP(userAddress);export function App() {import { useXMTP, usePushProtocol } from '@/hooks';```typescriptIn your app component:### 4. Initialize Messaging ServiceSet up XMTP and Push Protocol environment variables in `.env.local`.### 3. Configure Environment```npm install @xmtp/sdk @pushprotocol/restapi```bash### 2. Install Dependencies```# or manually run: supabase/migrations/002_messaging_schema.sqlsupabase db push```bashRun the messaging schema migration:### 1. Database Migration## Installation & Setup```NEXT_PUBLIC_MESSAGING_ENABLED=true# Messaging ServiceNEXT_PUBLIC_PUSH_ENV=prod# Push Protocol ConfigurationNEXT_PUBLIC_XMTP_ENV=production# XMTP Configuration```bashAdd to your `.env.local`:## Environment Variables```}  createdAt: string;  metadata?: Record<string, unknown>;  permissionType: 'none' | 'badge_gated' | 'follower_gated' | 'premium_only' | 'custom';  requiresPremium: boolean;  requiresVerification: boolean;  minBadgePoints: number;  minFollowerCount: number;  badgeId?: string;  conversationId: string;  id: string;interface MessagePermission {// Permission config}  updatedAt: string;  createdAt: string;  metadata?: Record<string, unknown>;  permissions?: MessagePermission;  isActive: boolean;  lastMessageAt?: string;  participant2: string;  participant1: string;  id: string;interface Conversation {// Conversation type}  updatedAt: string;  createdAt: string;  metadata?: Record<string, unknown>;  reactions?: MessageReaction[];  readAt?: string;  isRead: boolean;  onChainTxHash?: string;  pushMessageId?: string;  xmtpMessageId?: string;  encryptionType: 'none' | 'xmtp' | 'push';  isEncrypted: boolean;  messageType: 'direct' | 'group' | 'announcement';  contentType: 'text' | 'image' | 'file' | 'announcement';  content: string;  senderAddress: string;  conversationId: string;  id: string;interface Message {// Message type```typescript## TypeScript Types```/>  onMarkAsRead={handleMarkAsRead}  isRead={isRead}  recipientCount={broadcast.recipientCount}  isPinned={broadcast.isPinned}  senderName={senderName}  content={broadcast.content}  title={broadcast.title}  id={broadcast.id}<BroadcastAnnouncement```typescriptDisplay broadcast announcements.### `BroadcastAnnouncement````/>  userStats={userStats}  requiredBadge="Early Adopter"  permissionType="badge_gated"  hasPermission={hasPermission}<PermissionGate```typescriptDisplay badge-gating requirements.### `PermissionGate````/>  searchQuery={query}  onSelectConversation={handleSelect}  isLoading={isLoading}  selectedId={selectedId}  conversations={conversations}<ConversationsList```typescriptList of all conversations with search.### `ConversationsList````/>  userStats={userStats}  permissions={permissions}  onSendMessage={handleSend}  hasPermission={hasPermission}  isLoading={isLoading}  currentUserAddress={userAddress}  messages={messages}  conversation={conversation}<MessageThread```typescriptComplete message thread with header and input.### `MessageThread````/>  maxLength={1000}  placeholder="Type a message..."  disabled={!hasPermission}  onSend={handleSend}<MessageInput```typescriptInput field for composing messages.### `MessageInput````/>  isLoading={isLoading}  onReactionClick={handleReaction}  currentUserAddress={userAddress}  messages={messages}<MessagesList```typescriptDisplay messages in a conversation with reactions.### `MessagesList`## React Components```await initializePushProtocol(walletClient);// Initialize Push Protocol} = usePushProtocol('0x...');  initializePushProtocol,  error,  isInitializing,  isConnected,const {import { usePushProtocol } from '@/hooks';```typescript### `usePushProtocol(userAddress)````await initializeXMTP(walletClient);// Initialize XMTP} = useXMTP('0x...');  initializeXMTP,  error,  isInitializing,  isConnected,const {import { useXMTP } from '@/hooks';```typescript### `useXMTP(userAddress)````);  }    expiresAt: '2026-02-01T00:00:00Z',    isPinned: true,    targetBadgeId: 'badge-uuid',  {  'Please read this important message',  'Important Update',await sendBroadcast(// Send announcement to badge holders} = useBroadcasts('0x...');  markAsRead,  sendBroadcast,  fetchBroadcasts,  error,  isLoading,  broadcasts,const {import { useBroadcasts } from '@/hooks';```typescript### `useBroadcasts(userAddress)````});  requiresVerification: true,  permissionType: 'badge_gated',  badgeId: 'badge-uuid',await setMessagePermissions(conversationId, {// Set badge-gated messaging} = useMessagePermissions('0x...');  setMessagePermissions,  getPermissions,  error,  isLoading,  permissions,const {import { useMessagePermissions } from '@/hooks';```typescript### `useMessagePermissions(userAddress)````await blockUser('0xBadUser...', 'Spam');// Block a userawait sendMessage('0xRecipient...', 'Hello!', 'xmtp');// Send a message} = useMessaging('0x...');  addReaction,  markAsRead,  unblockUser,  blockUser,  sendMessage,  fetchMessages,  fetchConversations,  error,  isLoading,  messages,  conversations,const {import { useMessaging } from '@/hooks';```typescript### `useMessaging(userAddress)`## React Hooks```}  broadcastId: "uuid"  action: "markBroadcastAsRead",  userAddress: "0x...",{PUT /api/messages```typescript**Mark Broadcast as Read:**```}  messageId: "uuid"  action: "markAsRead",  userAddress: "0x...",{PUT /api/messages```typescript**Mark Message as Read:**### PUT `/api/messages````}  wallet: walletObject  action: "initPush",  userAddress: "0x...",{POST /api/messages```typescript**Initialize Push Protocol:**```}  wallet: walletObject  action: "initXMTP",  userAddress: "0x...",{POST /api/messages```typescript**Initialize XMTP:**```}  emoji: "ðŸ‘"  messageId: "uuid",  action: "addReaction",  userAddress: "0x...",{POST /api/messages```typescript**Add Reaction:**```}  permissionType: "badge_gated"  requiresPremium?: false,  requiresVerification?: true,  minBadgePoints?: 100,  minFollowerCount?: 10,  badgeId?: "uuid",  conversationId: "uuid",  action: "setPermissions",  userAddress: "0x...",{POST /api/messages```typescript**Set Message Permissions:**```}  expiresAt?: "2026-02-01T00:00:00Z"  isPinned?: true,  targetFollowerCountMin?: 100,  targetBadgeId?: "uuid",  content: "Message content",  title: "Announcement",  action: "broadcast",  userAddress: "0x...",{POST /api/messages```typescript**Send Broadcast:**```}  reason?: "string"  blockedAddress: "0x...",  action: "block",  userAddress: "0x...",{POST /api/messages```typescript**Block User:**```}  encryptionType: "xmtp" | "push" | "none"  content: "Hello!",  toAddress: "0x...",  action: "send",  userAddress: "0x...",{POST /api/messages```typescript**Send Message:**### POST `/api/messages````GET /api/messages?address=0x...&action=blocked// Get blocked usersGET /api/messages?address=0x...&action=reactions&messageId=uuid// Get message reactionsGET /api/messages?address=0x...&action=broadcasts&limit=20// Get user broadcastsGET /api/messages?address=0x...&action=permissions&conversationId=uuid// Get conversation permissionsGET /api/messages?address=0x...&action=messages&conversationId=uuid&limit=50// Get messages in conversationGET /api/messages?address=0x...&action=conversations// Get all conversations```typescript**Actions:**- `offset` (optional): Pagination offset- `limit` (optional): Results per page (default: 50)- `conversationId` (for messages/permissions)- `action` (required): Action to perform- `address` (required): User's wallet address**Query Parameters:**### GET `/api/messages`## API RoutesStore integration details for XMTP and Push Protocol connections.#### `xmtp_connections` & `push_connections````);  expires_at TIMESTAMP  created_at TIMESTAMP,  metadata JSONB,  is_pinned BOOLEAN,  recipient_count INTEGER,  target_follower_count_min INTEGER,  target_badge_id UUID,  content TEXT,  title TEXT,  sender_address TEXT,  id UUID PRIMARY KEY,CREATE TABLE message_broadcasts (```sql#### `message_broadcasts````);  created_at TIMESTAMP  reason TEXT,  blocked_address TEXT,  blocker_address TEXT,  id UUID PRIMARY KEY,CREATE TABLE blocked_users (```sql#### `blocked_users````);  created_at TIMESTAMP  metadata JSONB,  permission_type TEXT,  requires_premium BOOLEAN,  requires_verification BOOLEAN,  min_badge_points INTEGER,  min_follower_count INTEGER,  badge_id UUID,  conversation_id UUID,  id UUID PRIMARY KEY,CREATE TABLE message_permissions (```sql#### `message_permissions````);  updated_at TIMESTAMP  created_at TIMESTAMP,  metadata JSONB,  read_at TIMESTAMP,  is_read BOOLEAN,  on_chain_tx_hash TEXT,  push_message_id TEXT,  xmtp_message_id TEXT,  encryption_type TEXT,  is_encrypted BOOLEAN,  message_type TEXT,  content_type TEXT,  content TEXT,  sender_address TEXT,  conversation_id UUID,  id UUID PRIMARY KEY,CREATE TABLE messages (```sql#### `messages````);  updated_at TIMESTAMP  created_at TIMESTAMP,  metadata JSONB,  is_active BOOLEAN,  last_message_at TIMESTAMP,  participant_2 TEXT NOT NULL,  participant_1 TEXT NOT NULL,  id UUID PRIMARY KEY,CREATE TABLE conversations (```sql#### `conversations`### Tables## Database Schema- Optionally specify blocking reason- View list of blocked users- Block/unblock users from messaging### 6. **User Management**- Quick reaction buttons for common emojis- View reaction counts and who reacted- React to messages with emojis### 5. **Message Reactions**- Track read receipts- Set expiration dates- Pin important announcements- Target by badge, follower count, or send to all followers- Send announcements to multiple users at once### 4. **Announcements & Broadcasts**- **Premium Only**: Restrict to premium members- **Verification**: Require verified accounts- **Badge Points**: Minimum accumulated badge points- **Follower Gates**: Minimum follower count requirement- **Badge Requirements**: Only users with specific badges can messageControl who can message you with flexible gating:### 3. **Badge-Gated Messaging**- **Direct Storage**: Option for unencrypted messages stored on Supabase- **Push Protocol**: Decentralized push notifications and messaging- **XMTP (Extensible Message Transport Protocol)**: End-to-end encrypted messaging### 2. **Encryption Options**- Real-time message synchronization- On-chain transaction hashing for message verification- Hybrid messaging with XMTP and Push Protocol support- Send encrypted messages between wallet addresses### 1. **Direct Wallet-to-Wallet Messaging**## FeaturesProtoStack Profiles now includes a comprehensive **wallet-to-wallet messaging** system with **badge-gated access**, **XMTP integration**, and **Push Protocol support**.  "version": "1.0.0",
  "description": "Web3-native user profiles system - From Prototype to Production",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "lint:fix": "next lint --fix",
    "format": "prettier --write .",
    "typecheck": "tsc --noEmit",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test",
    "db:generate": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID > src/types/database.types.ts",
    "db:migrate": "supabase db push",
    "db:seed": "tsx scripts/seed.ts",
    "contracts:compile": "hardhat compile",
    "contracts:test": "hardhat test",
    "contracts:deploy:local": "hardhat run scripts/deploy.ts --network localhost",
    "contracts:deploy:testnet": "hardhat run scripts/deploy.ts --network sepolia",
    "contracts:deploy:mainnet": "hardhat run scripts/deploy.ts --network mainnet",
    "ipfs:upload": "tsx scripts/ipfs-upload.ts",
    "storybook": "storybook dev -p 6006",
    "build-storybook": "storybook build",
    "prepare": "husky install",
    "release": "semantic-release"
  },
  "dependencies": {
    "@headlessui/react": "^2.1.0",
    "@hookform/resolvers": "^3.3.4",
    "@radix-ui/react-avatar": "^1.0.4",
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-dropdown-menu": "^2.0.6",
    "@radix-ui/react-label": "^2.0.2",
    "@radix-ui/react-popover": "^1.0.7",
    "@radix-ui/react-select": "^2.0.0",
    "@radix-ui/react-separator": "^1.0.3",
    "@radix-ui/react-slot": "^1.0.2",
    "@radix-ui/react-switch": "^1.0.3",
    "@radix-ui/react-tabs": "^1.0.4",
    "@radix-ui/react-toast": "^1.1.5",
    "@radix-ui/react-tooltip": "^1.0.7",
    "@rainbow-me/rainbowkit": "^2.0.0",
    "@supabase/auth-helpers-nextjs": "^0.9.0",
    "@supabase/supabase-js": "^2.39.0",
    "@tanstack/react-query": "^5.17.0",
    "@tanstack/react-query-devtools": "^5.91.2",
    "@vercel/analytics": "^1.1.1",
    "@vercel/speed-insights": "^1.0.2",
    "@xmtp/sdk": "^11.0.0",
    "@pushprotocol/restapi": "^1.4.8",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "date-fns": "^3.2.0",
    "ethers": "^6.10.0",
    "framer-motion": "^10.18.0",
    "ipfs-http-client": "^60.0.1",
    "lucide-react": "^0.309.0",
    "next": "14.1.0",
    "next-auth": "^4.24.5",
    "next-themes": "^0.2.1",
    "nft.storage": "^7.1.1",
    "posthog-js": "^1.96.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hook-form": "^7.49.3",
    "react-hot-toast": "^2.4.1",
    "sharp": "^0.33.2",
    "siwe": "^2.1.4",
    "tailwind-merge": "^2.2.0",
    "tailwindcss-animate": "^1.0.7",
    "viem": "^2.5.0",
    "wagmi": "^2.5.0",
    "zod": "^3.22.4",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@commitlint/cli": "^18.4.4",
    "@commitlint/config-conventional": "^18.4.4",
    "@nomicfoundation/hardhat-toolbox": "^4.0.0",
    "@playwright/test": "^1.41.0",
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "@storybook/addon-essentials": "^7.6.7",
    "@storybook/addon-interactions": "^7.6.7",
    "@storybook/addon-links": "^7.6.7",
    "@storybook/blocks": "^7.6.7",
    "@storybook/nextjs": "^7.6.7",
    "@storybook/react": "^7.6.7",
    "@storybook/testing-library": "^0.2.2",
    "@testing-library/jest-dom": "^6.2.0",
    "@testing-library/react": "^14.1.2",
    "@types/node": "^20.11.0",
    "@types/react": "^18.2.47",
    "@types/react-dom": "^18.2.18",
    "@typescript-eslint/eslint-plugin": "^6.18.1",
    "@typescript-eslint/parser": "^6.18.1",
    "@vitejs/plugin-react": "^4.2.1",
    "@vitest/coverage-v8": "^1.2.0",
    "@vitest/ui": "^1.2.0",
    "autoprefixer": "^10.4.16",
    "dotenv": "^16.3.1",
    "eslint": "^8.56.0",
    "eslint-config-next": "14.1.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-storybook": "^0.6.15",
    "hardhat": "^2.19.4",
    "husky": "^8.0.3",
    "jsdom": "^23.2.0",
    "lint-staged": "^15.2.0",
    "postcss": "^8.4.33",
    "prettier": "^3.2.2",
    "prettier-plugin-tailwindcss": "^0.5.11",
    "semantic-release": "^23.0.0",
    "storybook": "^7.6.7",
    "supabase": "^1.131.0",
    "tailwindcss": "^3.4.1",
    "tsx": "^4.7.0",
    "typescript": "^5.3.3",
    "vitest": "^1.2.0"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,yml,yaml}": [
      "prettier --write"
    ]
  }
}
